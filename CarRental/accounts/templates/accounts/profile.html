{% extends 'base.html' %}
{% load static %}

{% block title %}Account Management | {{ user.first_name|default:user.username }}{% endblock %}

{% block extra_head %}
<style>
    :root {
        --bs-primary: #00BFFF; /* Light Blue / Deep Sky Blue */
        --bs-primary-rgb: 0, 191, 255;
        --bs-light: #f5f7f9; /* Very light grey/blue background for body */
        --bs-dark-grey: #6c757d;
        --bs-secondary: #6c757d; /* Dark Grey for secondary text/items */
    }

    /* Apply new primary color to existing classes */
    .text-primary { color: var(--bs-primary) !important; }
    /* Apply secondary color to the title/price */
    .text-secondary { color: var(--bs-secondary) !important; } 

    .btn-primary { 
        --bs-btn-bg: var(--bs-primary);
        --bs-btn-border-color: var(--bs-primary);
        --bs-btn-hover-bg: #0099cc; /* Slightly darker hover */
        --bs-btn-hover-border-color: #0099cc;
    }
    .btn-success {
        --bs-btn-bg: var(--bs-primary);
        --bs-btn-border-color: var(--bs-primary);
        --bs-btn-hover-bg: #0099cc;
        --bs-btn-hover-border-color: #0099cc;
    }
    /* Pending badge uses the main blue accent color */
    .badge.bg-primary { 
        background-color: var(--bs-primary) !important; 
        color: #fff !important; /* Ensure white text */
    }
    /* 2. General Page & Card Styling */
    body {
        background-color: var(--bs-light);
    }
    /* Main title icon */
    .profile-page h2 i {
        color: var(--bs-primary) !important;
    }
    .profile-page .card {
        border: 1px solid #e9ecef; /* Subtle border */
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05) !important;
    }

    /* 3. Tabs Styling */
    .profile-page .card-header {
        border-bottom: none;
        background-color: transparent !important;
    }
    .profile-page .nav-tabs {
        background-color: #ffffff !important; 
        border-bottom: 1px solid #dee2e6;
    }
    .profile-page .nav-link {
        color: var(--bs-dark-grey); /* Darker grey for non-active */
        border: none;
        border-radius: 0;
        padding-top: 1rem;
        padding-bottom: 1rem;
        transition: all 0.3s;
    }
    .profile-page .nav-link.active {
        color: var(--bs-primary) !important;
        background-color: #fff !important;
        border-bottom: 3px solid var(--bs-primary) !important; /* Strong Light Blue indicator */
        font-weight: 700 !important;
    }
    .profile-page .nav-link:hover:not(.active) {
        color: #333;
        background-color: #f8f9fa; /* Light grey hover */
    }
    
    /* 4. Booking Card Status Bars (Left Border Emphasis) */
    .profile-page .card.mb-3 {
        border-top: none;
        border-right: none;
        border-bottom: none;
        border-radius: 0.5rem;
        border-left: 5px solid #dee2e6; /* Default light border */
        transition: all 0.3s;
    }
    
    /* Status-specific left border color: KEEPING BOOTSTRAP DEFAULTS FOR STATUSES */
    /* PENDING (New Accent Blue) */
    .card.border-primary { 
        border-left-color: var(--bs-primary) !important; 
    } 
    /* CONFIRMED (Standard Green) */
    .card.border-success { 
        border-left-color: #198754 !important; 
    }
    /* ACTIVE (Standard Blue - Darker than primary) */
    .card.border-info { 
        border-left-color: #0d6efd !important; 
    }
    /* COMPLETED/OTHER (Standard Grey) */
    .card.border-secondary { 
        border-left-color: #6c757d !important; 
    }
    /* CANCELLED (Standard Red) */
    .card.border-danger { 
        border-left-color: #dc3545 !important; 
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container my-5 pt-5 profile-page">
    <h2 class="fw-bold mb-4 text-center"><i class="fas fa-user-cog me-2 text-primary"></i> Account Management</h2>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 rounded-4">
                
                <div class="card-header p-0">
                    <ul class="nav nav-tabs nav-fill rounded-top-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings-tab-pane" type="button" role="tab">
                                <i class="fas fa-history me-1 text-muted"> My Bookings </i>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-tab-pane" type="button" role="tab">
                                <i class="fas fa-user-edit me-1 text-muted"> Edit Details</i>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents-tab-pane" type="button" role="tab">
                                <i class="fas fa-file-alt me-1 text-muted"> ID & License</i>
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-4">
                    <div class="tab-content" id="profileTabsContent">
                        
                        <div class="tab-pane fade show active" id="bookings-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-muted mb-4">List of Recent Bookings</h4>

                            {% if bookings %}
                                {% for booking in bookings %}
                                    
                                    <div class="card mb-3 shadow-sm 
                                        {% if booking.status == 'PENDING' %}border-primary
                                        {% elif booking.status == 'CONFIRMED' %}border-success
                                        {% elif booking.status == 'ACTIVE' %}border-info
                                        {% elif booking.status == 'COMPLETED' %}border-secondary
                                        {% elif booking.status == 'CANCELLED' %}border-danger
                                        {% else %}border-secondary
                                        {% endif %}">
                                        
                                        <div class="card-body">
                                            <div class="row align-items-center">

                                                <div class="col-md-6 text-md-start mb-3 mb-md-0">
                                                    <h5 class="fw-bold mb-1">{{ booking.car.brand }} {{ booking.car.model_name }}</h5>
                                                    <p class="text-muted small mb-1">
                                                        {{ booking.start_date|date:"Y-m-d" }} to {{ booking.end_date|date:"Y-m-d" }}
                                                        (Duration: {{ booking.duration_days }} days)
                                                    </p>
                                                </div>

                                                <div class="col-md-6 text-md-start mt-3 mt-md-0">
                                                    <h4 class="text-muted fw-bold mb-1">
                                                        {{ booking.total_price }} SAR
                                                    </h4>

                                                    {% if booking.status == 'PENDING' %}
                                                        <span class="badge bg-primary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'CONFIRMED' %}
                                                        <span class="badge bg-success rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'ACTIVE' %}
                                                        <span class="badge bg-info rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'COMPLETED' %}
                                                        <span class="badge bg-secondary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% elif booking.status == 'CANCELLED' %}
                                                        <span class="badge bg-danger rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill px-3">{{ booking.get_status_display }}</span>
                                                    {% endif %}

                                                    {% if booking.status == 'PENDING' %}
                                                        <small class="d-block text-muted">
                                                            Pending admin review
                                                        </small>
                                                    {% endif %}
                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                {% endfor %}
                            {% else %}
                                <div class="alert alert-info text-center" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    You have no bookings yet.
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="tab-pane fade" id="settings-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-primary mb-4">Update Account Details</h4>

                            <form method="POST" action="{% url 'accounts:update_profile' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ user_form.first_name.label }}</label>
                                        {{ user_form.first_name }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ user_form.email.label }}</label>
                                        {{ user_form.email }}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ profile_form.phone_number.label }}</label>
                                        {{ profile_form.phone_number }}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">{{ profile_form.date_of_birth.label }}</label>
                                        {{ profile_form.date_of_birth }}
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-success mt-4 w-100"><i class="fas fa-save me-2"></i> Save Changes</button>
                            </form>
                            
                            <hr class="my-5">

                            <div class="text-center">
                                <h5 class="text-danger fw-bold">Permanently Delete Account</h5>
                                <p class="text-muted small">
                                    This action will permanently delete all your data and bookings from the system. This cannot be undone.
                                </p>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                    <i class="fas fa-trash me-2"></i> Delete Account
                                </button>
                            </div>

                        </div>

                        <div class="tab-pane fade" id="documents-tab-pane" role="tabpanel">
                            <h4 class="fw-bold text-primary mb-4">Add & Update Required Documents</h4>

                            {% if profile_instance.has_required_documents %}
                                <div class="alert alert-success text-center" role="alert">
                                    <i class="fas fa-check-circle me-2"></i> All required documents are uploaded!
                                </div>
                            {% else %}
                                <div class="alert alert-warning text-center" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i> Please upload your National ID/Residency and Driving License to complete your booking.
                                </div>
                            {% endif %}

                            <form method="POST" action="{% url 'accounts:update_profile' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                
                                <h6 class="fw-bold mt-4">1. National ID / Residency Image</h6>
                                {{ profile_form.national_id_image }}
                                {% if profile_instance.national_id_image %}
                                    <small class="text-success d-block mt-1">
                                        <i class="fas fa-file-image me-1"></i> Current file uploaded.
                                    </small>
                                {% endif %}
                                
                                <h6 class="fw-bold mt-4">2. Driving License Image</h6>
                                {{ profile_form.driving_license_image }}
                                {% if profile_instance.driving_license_image %}
                                    <small class="text-success d-block mt-1">
                                        <i class="fas fa-file-image me-1"></i> Current file uploaded.
                                    </small>
                                {% endif %}

                                <button type="submit" class="btn btn-primary btn-lg mt-5 w-100"><i class="fas fa-upload me-2"></i> Update Documents</button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirm Account Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to permanently delete your account? This action cannot be undone.</p>
                <small class="text-danger fw-bold">All your bookings and data will be deleted.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{% url 'accounts:delete_account' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger"><i class="fas fa-trash-alt me-2"></i> Confirm Deletion</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}